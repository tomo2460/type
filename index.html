<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚¤ã‚ªãƒ³çµåˆãƒ‘ã‚ºãƒ«ï¼šã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ“ãƒ«ãƒ€ãƒ¼</title>
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            const div = document.createElement('div');
            div.style.color = 'red';
            div.style.background = 'white';
            div.style.position = 'absolute';
            div.style.top = '0';
            div.style.left = '0';
            div.style.zIndex = '1000';
            div.style.padding = '10px';
            div.style.border = '2px solid red';
            div.style.fontWeight = 'bold';
            div.innerText = 'ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ' + message + ' (' + source + ':' + lineno + ')';
            document.body.appendChild(div);
        };
    </script>
    <!-- Matter.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <!-- Firebase SDK (v9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config moved to IIFE scope for security -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: #2c3e50;
            color: white;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: block;
            background: #34495e;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        canvas {
            border: 2px solid #ecf0f1;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background: #34495e;
            touch-action: none;
            /* ã‚¿ãƒƒãƒæ“ä½œã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã‚’ç„¡åŠ¹åŒ– */
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
        }

        #stats {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #next-ion-display {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }

        #compound-name-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            font-size: 40px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #f1c40f, 0 0 20px #e67e22;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            white-space: normal;
            /* æ”¹è¡Œã‚’è¨±å¯ */
            text-align: center;
            /* ä¸­å¤®æƒãˆ */
            line-height: 1.2;
            width: 90%;
            /* ã‚¹ãƒãƒ›ã§ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«å¹…åˆ¶é™ */
        }

        #electron-kun {
            position: absolute;
            top: 130px;
            /* å³ä¸Šã«ç§»å‹• */
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: #f1c40f;
            border-radius: 50%;
            border: 4px solid #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            box-shadow: 0 0 15px #f1c40f;
            transition: transform 0.2s;
            pointer-events: none;
            /* ã‚¹ãƒãƒ›ã§èª¤ã‚¿ãƒƒãƒ—ã‚’é˜²ããŸã‚ */
            z-index: 50;
        }

        #electron-speech {
            position: absolute;
            top: 130px;
            /* é›»å­ãã‚“ã®æ¨ª */
            right: 70px;
            /* é›»å­ãã‚“ã®å·¦å´ */
            background: white;
            color: black;
            padding: 10px 15px;
            border-radius: 15px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            max-width: 200px;
        }

        #electron-speech::after {
            content: '';
            position: absolute;
            top: 10px;
            right: -10px;
            /* å³å´ã«çªãå‡ºã™ */
            border-width: 10px 0 10px 10px;
            border-style: solid;
            border-color: transparent transparent transparent white;
        }

        #game-over-modal,
        #help-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 100;
        }

        #help-modal {
            background: rgba(44, 62, 80, 0.95);
            z-index: 210;
            /* ã‚¿ã‚¤ãƒˆãƒ«ã‚ˆã‚Šä¸Š */
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            width: 500px;
            color: white;
            text-align: left;
        }

        .modal-content h2 {
            text-align: center;
            color: #f1c40f;
            margin-top: 0;
        }

        .modal-content ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .modal-content li {
            margin-bottom: 10px;
            font-size: 18px;
            line-height: 1.5;
        }

        #game-over-modal h1 {
            font-size: 48px;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 24px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2ecc71;
        }

        .selected-ring {
            position: absolute;
            border: 3px solid #f1c40f;
            border-radius: 50%;
            pointer-events: none;
            box-sizing: border-box;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .flying-text {
            position: absolute;
            font-weight: bold;
            color: #f1c40f;
            pointer-events: none;
            animation: floatUp 1.5s forwards;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        #title-screen h1 {
            font-family: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", serif;
            /* é«˜ç´šæ„Ÿã®ã‚ã‚‹ã‚»ãƒªãƒ•ä½“ */
            font-size: 60px;
            background: linear-gradient(to bottom, #f1c40f, #f39c12, #b7950b);
            /* ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            -webkit-background-clip: text;
            background-clip: text;
            /* æ¨™æº–ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚è¿½åŠ  */
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            /* text-shadowã®ä»£ã‚ã‚Š */
            margin-bottom: 20px;
            line-height: 1.2;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 24px;
            color: #bdc3c7;
            margin-bottom: 40px;
            margin-bottom: 40px;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨CSS */
        #ranking-container {
            width: 80%;
            max-width: 400px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .ranking-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 18px;
        }

        .ranking-row:last-child {
            border-bottom: none;
        }

        .rank-num {
            font-weight: bold;
            width: 30px;
            color: #f1c40f;
        }

        .rank-name {
            flex-grow: 1;
            text-align: left;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .rank-score {
            font-family: monospace;
            font-size: 20px;
        }

        .rank-1 .rank-num {
            color: #e74c3c;
            font-size: 1.2em;
        }

        /* é‡‘ï¼ˆã«è¦‹ç«‹ã¦ãŸèµ¤/ç‰¹åˆ¥è‰²ï¼‰ */

        /* åå‰å…¥åŠ›ç”¨CSS */
        #name-input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80%;
            max-width: 300px;
        }

        .input-field {
            padding: 10px;
            font-size: 20px;
            border-radius: 5px;
            border: none;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="ui-layer">
            <div id="stats">
                <div>ã‚¹ã‚³ã‚¢: <span id="score-val">0</span></div>
                <div>ç§°å·: <span id="title-val">è¦‹ç¿’ã„éŒ¬é‡‘è¡“å¸«</span></div>
                <div>ã‚¹ãƒ”ãƒ¼ãƒ‰: <span id="speed-val">Lv.1</span></div>
            </div>
            <div id="next-ion-display">
                NEXT<br>
                <span id="next-ion-name" style="font-size: 20px; font-weight: bold;">?</span>
            </div>

            <div id="compound-name-display"></div>

            <div id="electron-kun">eâ»</div>
            <div id="electron-speech"></div>

            <div id="electron-speech"></div>
        </div>

        <!-- Canvas will be injected here -->

        <div id="game-over-modal">
            <h1>GAME OVER</h1>
            <p style="font-size: 24px; margin-bottom: 30px;">æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span></p>

            <!-- åå‰å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆãƒ©ãƒ³ã‚¯ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
            <div id="name-input-section" style="display: none;">
                <p style="color: #f1c40f; font-weight: bold;">ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ãŠã‚ã§ã¨ã†ï¼</p>
                <input type="text" id="player-name-input" class="input-field" placeholder="åå‰ã‚’å…¥åŠ›ï¼ˆ8æ–‡å­—ï¼‰" maxlength="8">
                <button class="btn" onclick="registerRank()" style="background: #e67e22;">ç™»éŒ²</button>
            </div>

            <!-- é€šå¸¸ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div id="gameover-buttons" style="display: flex; gap: 20px;">
                <button class="btn" onclick="goToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
                <button class="btn" onclick="restartGame(true)">ãƒªãƒˆãƒ©ã‚¤</button>
            </div>
        </div>

        <div id="title-screen">
            <h1>ã‚¯ãƒªã‚¹ã‚¿ãƒ«<br>ãƒ“ãƒ«ãƒ€ãƒ¼</h1>
            <p class="subtitle">ã‚¤ã‚ªãƒ³çµåˆãƒ‘ã‚ºãƒ«</p>

            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="ranking-container">
                <div style="text-align:center; color:#bdc3c7; margin-bottom:5px;">- TOP 3 -</div>
                <div id="ranking-list">
                    <!-- JSã§ç”Ÿæˆ -->
                    <div class="ranking-row"><span class="rank-name">Loading...</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 20px;">
                <button class="btn" id="start-btn" onclick="initGame('normal')">ãƒãƒ¼ãƒãƒ«</button>
                <button class="btn" onclick="initGame('hard')" style="background: #e74c3c;">ãƒãƒ¼ãƒ‰</button>
                <button class="btn" onclick="showHelp()" style="background: #3498db;">éŠã³æ–¹</button>
            </div>
        </div>

        <div id="help-modal">
            <div class="modal-content">
                <h2>éŠã³æ–¹</h2>
                <ul>
                    <li><strong>ãƒ«ãƒ¼ãƒ«:</strong> é™½ã‚¤ã‚ªãƒ³(+)ã¨é™°ã‚¤ã‚ªãƒ³(-)ã‚’çµ„ã¿åˆã‚ã›ã¦ã€åˆè¨ˆã®é›»æ°—ãŒã€Œ0ã€ã«ãªã‚‹ã‚ˆã†ã«æ¶ˆãã†ï¼</li>
                    <li><strong>ãƒœãƒ¼ãƒŠã‚¹:</strong> ä¸€åº¦ã«ãŸãã•ã‚“ã¤ãªã’ã¦æ¶ˆã™ã¨ã€ã‚¹ã‚³ã‚¢ãŒå¤§å¹…ã‚¢ãƒƒãƒ—ï¼ï¼ˆå€‹æ•°ã®äºŒä¹—ãƒœãƒ¼ãƒŠã‚¹ï¼‰</li>
                    <li><strong>ã‚­ãƒ£ãƒ³ã‚»ãƒ«:</strong> é¸ã‚“ã ãƒœãƒ¼ãƒ«ã‚’ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ã‚ˆã€‚</li>
                    <li><strong>æ³¨æ„:</strong> ç·šã‚’è¶…ãˆã¦ç©ã¿ä¸ŠãŒã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼</li>
                </ul>
                <h3 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 5px; margin-top: 20px;">
                    ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰</h3>
                <ul>
                    <li><strong>æ²ˆæ®¿:</strong> ã€Œé…¸åŒ–ç‰©ã€ã€Œæ°´é…¸åŒ–ç‰©ã€ãªã©ã®é›£æº¶æ€§å¡©ã¯ã€æ¶ˆæ»…ã›ãšã«<strong>ã€Œçµæ™¶ãƒ–ãƒ­ãƒƒã‚¯ã€</strong>ã«ãªã‚Šã¾ã™ï¼</li>
                    <li><strong>ç ´å£Š:</strong> çµæ™¶ãƒ–ãƒ­ãƒƒã‚¯ã¯<strong>10å›ã‚¿ãƒƒãƒ—</strong>ã—ã¦ç ´å£Šã—ã¦ãã ã•ã„ã€‚</li>
                </ul>
                <div style="text-align: center;">
                    <button class="btn" onclick="hideHelp()">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            "use strict";

            // --- Firebase Config & Init (Scoped) ---
            // å¤–éƒ¨ã‹ã‚‰ db å¤‰æ•°ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é®æ–­ã™ã‚‹ãŸã‚ã€å³æ™‚é–¢æ•°å†…ã§åˆæœŸåŒ–
            const firebaseConfig = {
                apiKey: "AIzaSyACKFsg3RK0DR5_ciEmUuH6KPkoo87KrNM",
                authDomain: "crystal-builder0802.firebaseapp.com",
                projectId: "crystal-builder0802",
                storageBucket: "crystal-builder0802.firebasestorage.app",
                messagingSenderId: "138379163430",
                appId: "1:138379163430:web:7d7bad6fda98ff721fb3e7"
            };

            let db;
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("Firebase Initialized (Protected Scope)");
            } catch (e) {
                console.warn("Firebase Config not found or invalid. Leaderboard disabled.", e);
            }
            // ---------------------------------------

            let gameMode = 'normal'; // 'normal' or 'hard'
            let IONS = []; // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã®ã‚¤ã‚ªãƒ³ãƒªã‚¹ãƒˆ

            // åŸºæœ¬ã‚¤ã‚ªãƒ³ãƒªã‚¹ãƒˆ
            const IONS_BASE = [
                { formula: "Naâº", charge: 1, radius: 40, color: "#e74c3c", type: "cation", baseName: "ãƒŠãƒˆãƒªã‚¦ãƒ ", name: "ãƒŠãƒˆãƒªã‚¦ãƒ ã‚¤ã‚ªãƒ³" },
                { formula: "MgÂ²âº", charge: 2, radius: 29, color: "#d35400", type: "cation", baseName: "ãƒã‚°ãƒã‚·ã‚¦ãƒ ", name: "ãƒã‚°ãƒã‚·ã‚¦ãƒ ã‚¤ã‚ªãƒ³" },
                { formula: "NHâ‚„âº", charge: 1, radius: 56, color: "#f39c12", type: "cation", baseName: "ã‚¢ãƒ³ãƒ¢ãƒ‹ã‚¦ãƒ ", name: "ã‚¢ãƒ³ãƒ¢ãƒ‹ã‚¦ãƒ ã‚¤ã‚ªãƒ³" },
                { formula: "AlÂ³âº", charge: 3, radius: 32, color: "#e67e22", type: "cation", baseName: "ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ", name: "ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ã‚¤ã‚ªãƒ³" },
                { formula: "CuÂ²âº", charge: 2, radius: 36, color: "#c0392b", type: "cation", baseName: "éŠ…(II)", name: "éŠ…(II)ã‚¤ã‚ªãƒ³" },
                { formula: "Clâ»", charge: -1, radius: 72, color: "#3498db", type: "anion", baseName: "å¡©åŒ–", name: "å¡©åŒ–ç‰©ã‚¤ã‚ªãƒ³" },
                { formula: "SOâ‚„Â²â»", charge: -2, radius: 99, color: "#8e44ad", type: "anion", baseName: "ç¡«é…¸", name: "ç¡«é…¸ã‚¤ã‚ªãƒ³" },
                { formula: "OÂ²â»", charge: -2, radius: 56, color: "#1abc9c", type: "anion", baseName: "é…¸åŒ–", name: "é…¸åŒ–ç‰©ã‚¤ã‚ªãƒ³" },
                { formula: "COâ‚ƒÂ²â»", charge: -2, radius: 88, color: "#9b59b6", type: "anion", baseName: "ç‚­é…¸", name: "ç‚­é…¸ã‚¤ã‚ªãƒ³" },
                { formula: "OHâ»", charge: -1, radius: 64, color: "#2980b9", type: "anion", baseName: "æ°´é…¸åŒ–", name: "æ°´é…¸åŒ–ç‰©ã‚¤ã‚ªãƒ³" }
            ];

            // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰è¿½åŠ ã‚¤ã‚ªãƒ³
            const IONS_HARD_ADD = [
                { formula: "Agâº", charge: 1, radius: 32, color: "#bdc3c7", type: "cation", baseName: "éŠ€", name: "éŠ€ã‚¤ã‚ªãƒ³" }, // 40*0.8=32
                { formula: "CaÂ²âº", charge: 2, radius: 28, color: "#d35400", type: "cation", baseName: "ã‚«ãƒ«ã‚·ã‚¦ãƒ ", name: "ã‚«ãƒ«ã‚·ã‚¦ãƒ ã‚¤ã‚ªãƒ³" } // 35*0.8=28
            ];

            const TITLES = [
                { score: 0, title: "è¦‹ç¿’ã„éŒ¬é‡‘è¡“å¸«", interval: 2000, scoreMult: 0.5 },
                { score: 1000, title: "ã‚¤ã‚ªãƒ³ä½¿ã„", interval: 1500, scoreMult: 0.8 },
                { score: 3000, title: "çµæ™¶ã®è·äºº", interval: 1200, scoreMult: 1.0 },
                { score: 5000, title: "çµåˆãƒã‚¹ã‚¿ãƒ¼", interval: 1000, scoreMult: 1.5 },
                { score: 10000, title: "å¡©ã®ç‹", interval: 800, scoreMult: 2.0 },
                { score: 20000, title: "è³¢è€…ã®çŸ³ã®æ‰€æœ‰è€…", interval: 600, scoreMult: 3.0 },
                { score: 50000, title: "å…ƒç´ ã®æ”¯é…è€…", interval: 500, scoreMult: 5.0 },
                { score: 75000, title: "å®‡å®™ã®è¨­è¨ˆè€…", interval: 400, scoreMult: 8.0 },
                { score: 100000, title: "åŒ–å­¦ã®ç¥", interval: 300, scoreMult: 12.0 },
                { score: 300000, title: "çœŸç†", interval: 200, scoreMult: 20.0 }
            ];

            // --- Sound Manager (Web Audio API) ---
            class SoundManager {
                constructor() {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }

                playTone(freq, type, duration, vol = 0.1) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                }

                playSelect() {
                    this.playTone(880, 'sine', 0.1, 0.1); // Low ping
                }

                playCombine() {
                    // Arpeggio
                    setTimeout(() => this.playTone(523.25, 'sine', 0.3, 0.1), 0); // C5
                    setTimeout(() => this.playTone(659.25, 'sine', 0.3, 0.1), 100); // E5
                    setTimeout(() => this.playTone(783.99, 'sine', 0.4, 0.1), 200); // G5
                }

                playError() {
                    this.playTone(150, 'sawtooth', 0.3, 0.1); // Buzz
                }

                playGameOver() {
                    this.playTone(300, 'triangle', 1.0, 0.2);
                    setTimeout(() => this.playTone(250, 'triangle', 1.0, 0.2), 300);
                    setTimeout(() => this.playTone(200, 'triangle', 1.5, 0.2), 600);
                }
            }

            const sound = new SoundManager();

            // --- Matter.js ã‚¨ã‚¤ãƒªã‚¢ã‚¹ ---
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€initGameå†…ã§å®šç¾©ã™ã‚‹ã‹ã€loadã‚¤ãƒ™ãƒ³ãƒˆå†…ã§å®šç¾©ã™ã‚‹
            let Engine, Render, Runner, World, Bodies, Body, Events, Composite, Mouse, MouseConstraint;

            // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ---
            let engine, render, runner;
            let score = 0;
            let selectedBodies = []; // é¸æŠã•ã‚ŒãŸãƒœãƒ¼ãƒ«
            let nextIonIndex = 0;
            let isGameOver = false;
            let activePairs = new Set(); // æ¥è§¦ãƒœãƒ¼ãƒŠã‚¹åˆ¤å®šç”¨
            let spawnTimer; // setTimeoutç”¨
            let currentSpawnInterval = 2000; // ç¾åœ¨ã®ã‚¹ãƒãƒ¼ãƒ³é–“éš”
            let currentScoreMultiplier = 0.5; // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢å€ç‡
            let scaleFactor = 1; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°

            // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ›´æ–°ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®å†è¨ˆç®—ãŒè¤‡é›‘ãªãŸã‚ï¼‰
                    location.reload();
                }, 300);
            });

            function calculateDimensions() {
                const TARGET_AR = 630 / 1050; // ãƒ’ã‚¨ãƒ©ãƒ«ã‚­ãƒ¼æ¯”ç‡ã¯0.6ã§ç¶­æŒ
                const BASE_HEIGHT = 1050;  // åŸºæº–é«˜ã•ã‚’å¤‰æ›´ï¼ˆã‚ˆã‚Šåºƒãä½¿ãˆã‚‹ã‚ˆã†ã«ï¼‰

                let h = window.innerHeight;
                let w = h * TARGET_AR;

                // å¹…ãŒç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆ
                if (w > window.innerWidth) {
                    w = window.innerWidth;
                    h = w / TARGET_AR;
                }

                // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
                const scale = h / BASE_HEIGHT;

                return { width: w, height: h, scale: scale };
            }

            function initGame(mode) {
                console.log("initGame ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ. Mode:", mode);
                gameMode = mode || 'normal';

                // ã‚¤ã‚ªãƒ³ãƒªã‚¹ãƒˆã®æ§‹ç¯‰
                IONS = [...IONS_BASE];
                if (gameMode === 'hard') {
                    IONS.push(...IONS_HARD_ADD);
                    document.getElementById('title-val').innerText = "è¦‹ç¿’ã„éŒ¬é‡‘è¡“å¸« (Hard)";
                } else {
                    document.getElementById('title-val').innerText = "è¦‹ç¿’ã„éŒ¬é‡‘è¡“å¸«";
                }

                // UIã®ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('title-screen').style.display = 'none';
                score = 0;
                document.getElementById('score-val').innerText = score;

                const container = document.getElementById('game-container');
                if (!container) {
                    console.error("ã‚¨ãƒ©ãƒ¼: game-container ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
                    return;
                }

                // æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (render) {
                    Render.stop(render);
                    if (render.canvas) {
                        render.canvas.remove();
                    }
                    render = null;
                }
                if (runner) {
                    Runner.stop(runner);
                    runner = null;
                }
                if (engine) {
                    World.clear(engine.world);
                    Engine.clear(engine);
                    engine = null;
                }

                // Matter.js ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®š
                Engine = Matter.Engine;
                Render = Matter.Render;
                Runner = Matter.Runner;
                World = Matter.World;
                Bodies = Matter.Bodies;
                Body = Matter.Body;
                Events = Matter.Events;
                Composite = Matter.Composite;
                Mouse = Matter.Mouse;
                Composite = Matter.Composite;
                Mouse = Matter.Mouse;
                MouseConstraint = Matter.MouseConstraint;
                const Sleeping = Matter.Sleeping; // Sleepingã‚’è¿½åŠ 

                engine = Engine.create();
                engine.world.gravity.y = 1; // é‡åŠ›ã¯ã‚¹ã‚±ãƒ¼ãƒ«ã«é–¢ã‚ã‚‰ãš1ï¼ˆè¦‹ãŸç›®ã®é€Ÿåº¦ã¯ç›¸å¯¾çš„ã«å¤‰ã‚ã‚‹ãŒã€ã‚²ãƒ¼ãƒ æ€§ã¯ç¶­æŒï¼‰

                // æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ­ã‚¸ãƒƒã‚¯
                const dims = calculateDimensions();
                const width = dims.width;
                const height = dims.height;
                scaleFactor = dims.scale;

                console.log(`Dims: ${width}x${height}, Scale: ${scaleFactor}`);



                render = Render.create({
                    element: container,
                    engine: engine,
                    options: {
                        width: width,
                        height: height,
                        wireframes: false,
                        background: '#34495e',
                        pixelRatio: window.devicePixelRatio
                    }
                });

                // å£ã®è¿½åŠ 
                const wallThick = 100 * scaleFactor; // å£ã®åšã¿ã‚‚ã‚¹ã‚±ãƒ¼ãƒ«
                const wallOptions = { isStatic: true, render: { fillStyle: '#95a5a6' } };

                // åºŠ
                const ground = Bodies.rectangle(width / 2, height + (wallThick / 2), width * 3, wallThick, wallOptions);
                // å·¦å£
                const leftWall = Bodies.rectangle(0 - (wallThick / 2), height / 2, wallThick, height * 2, wallOptions);
                // å³å£
                const rightWall = Bodies.rectangle(width + (wallThick / 2), height / 2, wallThick, height * 2, wallOptions);

                World.add(engine.world, [ground, leftWall, rightWall]);

                World.add(engine.world, [ground, leftWall, rightWall]);

                // ã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯å‡¦ç† (Pointer Eventsã‚’ä½¿ç”¨)
                // Matter.jsã®MouseConstraintã¯Windowsã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç­‰ã§ã‚¿ãƒƒãƒåå¿œãŒæ‚ªã„å ´åˆãŒã‚ã‚‹ãŸã‚
                // ãƒã‚¤ãƒ†ã‚£ãƒ–ã®Pointer Eventã§åˆ¶å¾¡ã™ã‚‹
                render.canvas.addEventListener('pointerdown', function (event) {
                    if (isGameOver) return;

                    // åº§æ¨™å¤‰æ› (Canvasã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨è«–ç†ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è€ƒæ…®)
                    const rect = render.canvas.getBoundingClientRect();
                    const scaleX = render.options.width / rect.width;
                    const scaleY = render.options.height / rect.height;
                    const x = (event.clientX - rect.left) * scaleX;
                    const y = (event.clientY - rect.top) * scaleY;

                    const bodies = Composite.allBodies(engine.world);
                    const clickedBodies = Matter.Query.point(bodies, { x: x, y: y });

                    let isClicked = false;
                    for (let b of clickedBodies) {
                        if (b.label === 'crystal') {
                            b.hp--;
                            sound.playError(); // ç¡¬ã„éŸ³ãŒè‰¯ã„ãŒã¨ã‚Šã‚ãˆãšerroréŸ³ã‚’ä»£ç”¨

                            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ¼”å‡ºï¼ˆç°¡æ˜“ï¼‰
                            createParticles(x, y, 3, "#7f8c8d");

                            if (b.hp <= 0) {
                                World.remove(engine.world, b);
                                sound.playCombine(); // ç ´å£ŠéŸ³
                                score += 500; // ç ´å£Šãƒœãƒ¼ãƒŠã‚¹
                                createParticles(x, y, 10, "#7f8c8d");
                                updateScore();
                            }
                            isClicked = true;
                            break; // çµæ™¶å‡¦ç†ã—ãŸã‚‰çµ‚äº†
                        }
                        if (b.label && b.label.startsWith('ion')) {
                            handleIonClick(b);
                            isClicked = true;
                            break;
                        }
                    }
                });

                // è¡çªã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒœãƒ¼ãƒŠã‚¹åˆ¤å®šç”¨ï¼‰
                Events.on(engine, 'collisionStart', function (event) {
                    const pairs = event.pairs;
                    for (let i = 0; i < pairs.length; i++) {
                        const pair = pairs[i];
                        const idA = pair.bodyA.id;
                        const idB = pair.bodyB.id;
                        const key = idA < idB ? `${idA}-${idB}` : `${idB}-${idA}`;
                        activePairs.add(key);
                    }
                });

                Events.on(engine, 'collisionEnd', function (event) {
                    const pairs = event.pairs;
                    for (let i = 0; i < pairs.length; i++) {
                        const pair = pairs[i];
                        const idA = pair.bodyA.id;
                        const idB = pair.bodyB.id;
                        const key = idA < idB ? `${idA}-${idB}` : `${idB}-${idA}`;
                        activePairs.delete(key);
                    }
                });

                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®šã¨æ›´æ–°ãƒ«ãƒ¼ãƒ—
                Events.on(engine, 'beforeUpdate', function () {
                    if (isGameOver) return;

                    const deadlineY = height * 0.2;
                    const bodies = Composite.allBodies(engine.world);
                    for (let b of bodies) {
                        // ä¿®æ­£: ç”»é¢å¤–ï¼ˆç”Ÿæˆç›´å¾Œ z < 0ï¼‰ã®ãƒœãƒ¼ãƒ«ã¯åˆ¤å®šã‹ã‚‰é™¤å¤–ã™ã‚‹
                        if ((b.label.startsWith('ion') || b.label === 'crystal') && b.speed < 0.5 && b.position.y > 0 && b.position.y < deadlineY) {
                            triggerGameOver();
                            break;
                        }
                    }
                });

                Render.run(render);
                runner = Runner.run(Runner.create(), engine);

                // ã‚¹ãƒãƒ¼ãƒ³é–‹å§‹
                pickNextIon();
                scheduleNextSpawn();
                setupRenderEvents(); // Renderã‚¤ãƒ™ãƒ³ãƒˆã‚’ã“ã“ã§è¨­å®š
            }

            function scheduleNextSpawn() {
                if (isGameOver) return;
                if (spawnTimer) clearTimeout(spawnTimer);
                spawnTimer = setTimeout(() => {
                    spawnIon();
                    scheduleNextSpawn();
                }, currentSpawnInterval);
            }

            function pickNextIon() {
                console.log("æ¬¡ã®ã‚¤ã‚ªãƒ³ã‚’é¸æŠä¸­");
                nextIonIndex = Math.floor(Math.random() * IONS.length);
                updateNextIonDisplay();
            }

            function updateNextIonDisplay() {
                if (!IONS || IONS.length === 0) return;
                const ion = IONS[nextIonIndex];
                const nextDisplay = document.getElementById('next-ion-name');
                if (nextDisplay) {
                    nextDisplay.innerText = ion.formula;
                    nextDisplay.style.color = ion.color;
                } else {
                    console.error("ã‚¨ãƒ©ãƒ¼: next-ion-name è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                }
            }

            function spawnIon() {
                if (isGameOver) return;
                console.log("ã‚¤ã‚ªãƒ³ã‚’ç”Ÿæˆä¸­...");

                const ionData = IONS[nextIonIndex];
                const width = render.options.width;

                // ã‚¹ãƒãƒ¼ãƒ³ç¯„å›²ä¿®æ­£ (ã‚¹ã‚±ãƒ¼ãƒ«å¯¾å¿œ)
                const margin = 100 * scaleFactor;
                // width - margin*2 ã®ç¯„å›²ã§ãƒ©ãƒ³ãƒ€ãƒ 
                // ãŸã ã—å¹…ãŒç‹­ã™ãã‚‹å ´åˆã®ã‚¬ãƒ¼ãƒ‰
                const spawnWidth = Math.max(10, width - margin * 2);
                const x = Math.random() * spawnWidth + margin;

                const radius = ionData.radius * scaleFactor;

                const body = Bodies.circle(x, -radius * 2, radius, {
                    restitution: 0.5,
                    friction: 0.05,
                    label: `ion-${ionData.formula}`,
                    render: {
                        fillStyle: ionData.color,
                        strokeStyle: 'white',
                        lineWidth: 2
                    },
                    plugin: {
                        ionData: ionData
                    }
                });

                Body.setVelocity(body, { x: (Math.random() - 0.5) * 2, y: 0 });
                World.add(engine.world, body);

                pickNextIon();
            }

            // ãƒœãƒ¼ãƒ«ä¸Šã®æ–‡å­—æå†™ã¨é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆã®æç”»
            // Events.on(render, 'afterRender', ...) ã¯ Render ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆå¾Œã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒ
            // initGameå†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ render ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã€ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚‚ initGame å†…ã«ç§»å‹•ã™ã‚‹ã‹
            // ã‚‚ã—ãã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã® render ãŒè¨­å®šã•ã‚ŒãŸå¾Œã«å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
            // ã“ã“ã§ã¯ initGame å®Ÿè¡Œå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã™ã‚‹å½¢ã«ä¿®æ­£ã—ã¾ã™ã€‚

            // ä¿®æ­£: initGameã®ä¸­ã§ render ãŒä½œã‚‰ã‚ŒãŸå¾Œã« Events.on ã‚’è¨­å®šã™ã‚‹ã®ãŒæœ€ã‚‚å®‰å…¨ã§ã™ã€‚
            // ãã®ãŸã‚ã€initGame é–¢æ•°å†…ã«ç§»å‹•ã•ã›ã¾ã™ãŒã€æ–‡å­—æ•°ã®é–¢ä¿‚ã§ä¸€æ—¦ã“ã“ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ã«é–¢æ•°ã‚’å®šç¾©ã—ã€initGameã‹ã‚‰å‘¼ã³å‡ºã—ã¾ã™ã€‚

            function setupRenderEvents() {
                Events.on(render, 'afterRender', function () {
                    const ctx = render.context;
                    const bodies = Composite.allBodies(engine.world);

                    const scaledFontSize = Math.round(26 * scaleFactor);
                    ctx.font = `bold ${scaledFontSize}px Arial`;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    for (let b of bodies) {
                        if (b.label.startsWith('ion')) {
                            // åŒ–å­¦å¼ã‚’æç”»
                            ctx.fillStyle = "white";
                            ctx.fillText(b.plugin.ionData.formula, b.position.x, b.position.y);

                            // é¸æŠæ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæç”»
                            if (selectedBodies.includes(b)) {
                                ctx.beginPath();
                                ctx.arc(b.position.x, b.position.y, b.circleRadius + 5, 0, 2 * Math.PI);
                                ctx.strokeStyle = "#f1c40f";
                                ctx.lineWidth = 4;
                                ctx.stroke();
                            }
                        }
                    }

                    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³ã®æç”»
                    const width = render.options.width;
                    const deadlineY = render.options.height * 0.2;

                    // å±é™ºã‚¨ãƒªã‚¢ã®èƒŒæ™¯ï¼ˆè–„ã„èµ¤ï¼‰
                    ctx.fillStyle = "rgba(255, 0, 0, 0.05)";
                    ctx.fillRect(0, 0, width, deadlineY);

                    // ãƒ©ã‚¤ãƒ³
                    ctx.beginPath();
                    ctx.moveTo(0, deadlineY);
                    ctx.lineTo(width, deadlineY);
                    ctx.strokeStyle = "rgba(255, 0, 0, 0.8)"; // æ¿ƒã„èµ¤
                    ctx.lineWidth = 4; // å¤ªã
                    ctx.setLineDash([15, 10]); // ç‚¹ç·š
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.lineWidth = 1; // æˆ»ã™

                    // è­¦å‘Šãƒ†ã‚­ã‚¹ãƒˆ
                    ctx.font = "bold 20px Arial";
                    ctx.fillStyle = "rgba(255, 0, 0, 0.8)";
                    ctx.fillText("DANGER LIMIT", width / 2, deadlineY - 10);

                    // çµæ™¶ãƒ–ãƒ­ãƒƒã‚¯ã®æç”»
                    ctx.font = "bold 20px Arial";
                    for (let b of bodies) {
                        if (b.label === 'crystal') {
                            // å®Ÿéš›ã«ã¯é ‚ç‚¹ã‚’ä½¿ã£ãŸã»ã†ãŒæ­£ç¢ºã ãŒã€å››è§’å½¢ãªã®ã§
                            ctx.beginPath();
                            ctx.moveTo(b.vertices[0].x, b.vertices[0].y);
                            for (let j = 1; j < b.vertices.length; j++) ctx.lineTo(b.vertices[j].x, b.vertices[j].y);
                            ctx.closePath();
                            ctx.fillStyle = "#7f8c8d"; // çµæ™¶ã®è‰²
                            ctx.fill();
                            ctx.strokeStyle = "#2c3e50"; // æ ç·š
                            ctx.lineWidth = 2;
                            ctx.stroke();

                            // HPè¡¨ç¤º
                            ctx.fillStyle = "white";
                            ctx.fillText(b.hp, b.position.x, b.position.y);
                        }
                    }

                    ctx.font = "bold 26px Arial"; // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’æˆ»ã™
                });
            }


            // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
            function handleIonClick(body) {
                // ã™ã§ã«é¸æŠæ¸ˆã¿ãªã‚‰é¸æŠè§£é™¤
                const idx = selectedBodies.indexOf(body);
                if (idx !== -1) {
                    selectedBodies.splice(idx, 1);
                    return;
                }

                const ionInfo = body.plugin.ionData;

                // åˆ¶é™ç·©å’Œ: åŒç¬¦å·ã§ã‚‚é¸æŠå¯èƒ½ã«ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã®æ¥µæ€§ãƒã‚§ãƒƒã‚¯ã¯å‰Šé™¤
                selectedBodies.push(body);

                // æ­£å‘³é›»è·ã®è¨ˆç®—
                let netCharge = 0;
                selectedBodies.forEach(b => netCharge += b.plugin.ionData.charge);

                if (netCharge === 0) {
                    // å³å¯†ãªçµåˆãƒã‚§ãƒƒã‚¯: é™½ã‚¤ã‚ªãƒ³ãƒ»é™°ã‚¤ã‚ªãƒ³ã¯ãã‚Œãã‚Œ1ç¨®é¡ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„
                    const cations = selectedBodies.filter(b => b.plugin.ionData.type === 'cation');
                    const anions = selectedBodies.filter(b => b.plugin.ionData.type === 'anion');

                    const cationTypes = new Set(cations.map(b => b.plugin.ionData.formula));
                    const anionTypes = new Set(anions.map(b => b.plugin.ionData.formula));

                    if (cationTypes.size > 1 || anionTypes.size > 1) {
                        showElectronSpeech("ç¨®é¡ãŒæ··ã–ã£ã¦ã‚‹ã‚ˆï¼ğŸ˜–");
                        shakeElectron();
                        sound.playError();
                        return;
                    }

                    // åŒ–åˆç‰©åã®ç”Ÿæˆ
                    let compoundName = "";
                    if (cations.length > 0 && anions.length > 0) {
                        const cationName = cations[0].plugin.ionData.baseName;
                        const anionName = anions[0].plugin.ionData.baseName;
                        compoundName = anionName + cationName;
                    }

                    // æ²ˆæ®¿åˆ¤å®š (Hardãƒ¢ãƒ¼ãƒ‰ã®ã¿)
                    let isPrecipitate = false;
                    if (gameMode === 'hard' && cations.length > 0 && anions.length > 0) {
                        const cationFormula = cations[0].plugin.ionData.formula; // ä»£è¡¨ã‚¤ã‚ªãƒ³ã§åˆ¤å®š
                        const anionFormula = anions[0].plugin.ionData.formula;

                        // æ²ˆæ®¿åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                        // Na+, NH4+: å¸¸ã«æº¶è§£ (æ²ˆæ®¿ãªã—)
                        // Ag+: Cl, SO4, O, CO3, OH ã™ã¹ã¦æ²ˆæ®¿ (AgNO3ãªã©ã¯ç„¡ã„ã®ã§)
                        // Ca2+: Clä»¥å¤–ã¯æ²ˆæ®¿ (CaSO4, CaO, CaCO3, Ca(OH)2)
                        // Cu2+, Mg2+, Al3+: Cl, SO4ä»¥å¤–ã¯æ²ˆæ®¿ (é…¸åŒ–ç‰©, ç‚­é…¸å¡©, æ°´é…¸åŒ–ç‰©)

                        if (cationFormula === "Naâº" || cationFormula === "NHâ‚„âº") {
                            isPrecipitate = false;
                        } else if (cationFormula === "Agâº") {
                            isPrecipitate = true; // ä»Šå›ã®é™°ã‚¤ã‚ªãƒ³ãƒªã‚¹ãƒˆãªã‚‰å…¨ã¦æ²ˆæ®¿
                        } else if (cationFormula === "CaÂ²âº") {
                            isPrecipitate = (anionFormula !== "Clâ»");
                        } else if (["CuÂ²âº", "MgÂ²âº", "AlÂ³âº"].includes(cationFormula)) {
                            // å¡©åŒ–ç‰©ã€ç¡«é…¸å¡©ã¯å¯æº¶ã€‚ãã‚Œä»¥å¤–(é…¸åŒ–ç‰©, ç‚­é…¸å¡©, æ°´é…¸åŒ–ç‰©)ã¯æ²ˆæ®¿
                            if (anionFormula === "Clâ»" || anionFormula === "SOâ‚„Â²â»") {
                                isPrecipitate = false;
                            } else {
                                isPrecipitate = true;
                            }
                        }
                    }

                    if (isPrecipitate) {
                        // æ²ˆæ®¿ç”Ÿæˆï¼ˆçµæ™¶åŒ–ï¼‰
                        const x = selectedBodies.reduce((sum, b) => sum + b.position.x, 0) / selectedBodies.length;
                        const y = selectedBodies.reduce((sum, b) => sum + b.position.y, 0) / selectedBodies.length;

                        // é¸æŠã•ã‚ŒãŸã‚¤ã‚ªãƒ³ã®åŠå¾„ã®åˆè¨ˆã«åŸºã¥ã„ã¦çµæ™¶ã®ã‚µã‚¤ã‚ºã‚’æ±ºå®š
                        let totalRadius = selectedBodies.reduce((sum, b) => sum + b.circleRadius, 0);
                        // ã‚µã‚¤ã‚ºã‚’1.5å€ã«æ‹¡å¤§ (req: ä»Šã®1.5å€)
                        // å…ƒ: totalRadius * 0.8 -> æ–°: totalRadius * 0.8 * 1.5 = totalRadius * 1.2
                        const size = totalRadius * 1.2;

                        const crystal = Bodies.rectangle(x, y, size, size, {
                            label: 'crystal',
                            restitution: 0.2,
                            friction: 0.8,
                            density: 0.05, // é‡ãã™ã‚‹
                            render: {
                                fillStyle: '#7f8c8d', // çµæ™¶ã®è‰²
                                strokeStyle: '#2c3e50',
                                lineWidth: 2
                            }
                        });
                        crystal.hp = 10;
                        crystal.maxHp = 10;

                        World.add(engine.world, crystal);

                        // å…ƒã®ã‚¤ã‚ªãƒ³ã‚’å‰Šé™¤
                        selectedBodies.forEach(b => {
                            World.remove(engine.world, b);
                        });

                        sound.playError(); // é‡åšæ„Ÿã®ã‚ã‚‹éŸ³ã®ä»£ã‚ã‚Šã«erroréŸ³ã‚’ä»£ç”¨
                        showCompoundName(compoundName + " (æ²ˆæ®¿!)");
                    } else {
                        sound.playCombine();

                        // ã‚¹ã‚³ã‚¢è¨ˆç®— (ã¾ã¨ã‚æ¶ˆã—ãƒœãƒ¼ãƒŠã‚¹å¼·åŒ–ã€ãŸã ã—åŸºæœ¬ç‚¹ã¯åŠæ¸›)
                        // ãƒˆãƒ¼ã‚¿ãƒ« = (length * 50) * length (multiplier) = 50 * length^2
                        let points = selectedBodies.length * 50;

                        // çµæ™¶æ ¼å­ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæ¥è§¦ãƒœãƒ¼ãƒŠã‚¹ï¼‰
                        let contactBonus = 0;
                        let connections = 0;
                        for (let i = 0; i < selectedBodies.length; i++) {
                            for (let j = i + 1; j < selectedBodies.length; j++) {
                                const idA = selectedBodies[i].id;
                                const idB = selectedBodies[j].id;
                                const key = idA < idB ? `${idA}-${idB}` : `${idB}-${idA}`;
                                if (activePairs.has(key)) {
                                    connections++;
                                }
                            }
                        }

                        if (connections > 0) {
                            contactBonus = connections * 25; // ãƒœãƒ¼ãƒŠã‚¹ã‚‚åŠæ¸›
                            showFlyingText(`çµæ™¶ãƒœãƒ¼ãƒŠã‚¹ +${contactBonus}!`, selectedBodies[0].position);
                        }

                        // è¤‡é›‘æ€§ãƒœãƒ¼ãƒŠã‚¹ (ä¹—æ•°)
                        const multiplier = Math.max(1, selectedBodies.length); // length - 1 ã§ã¯ãªã length ã‚’ãã®ã¾ã¾ä¹—æ•°ã«ã™ã‚‹ï¼ˆäºŒä¹—åŠ¹æœï¼‰
                        const baseTotal = (points + contactBonus) * multiplier;

                        // ãƒ¬ãƒ™ãƒ«ï¼ˆç§°å·ï¼‰ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢å€ç‡é©ç”¨
                        const totalAdd = Math.floor(baseTotal * currentScoreMultiplier);

                        score += totalAdd;

                        // ãƒœãƒ¼ãƒ«ã®å‰Šé™¤
                        selectedBodies.forEach(b => {
                            World.remove(engine.world, b);
                        });

                        showCompoundName(compoundName);
                    }

                    updateScore();
                    checkTitle();
                    successClear(); // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨é›»å­ãã‚“ã®å‡¦ç†
                    const sign = netCharge > 0 ? '+' : '';
                    showElectronSpeech(`ç¾åœ¨ã®é›»è·: ${sign}${netCharge}`);
                    sound.playSelect();

                    selectedBodies = []; // é¸æŠè§£é™¤
                }
            }

            function successClear() {
                // ã‚¹ã‚³ã‚¢è¨ˆç®—ã¯ handleIonClick å´ã«ç§»å‹•ã—ãŸã®ã§ã“ã“ã§ã¯è¡Œã‚ãªã„
                // ã¨è¨€ã„ãŸã„ã¨ã“ã‚ã ãŒã€handleIonClick å´ã®å¤‰æ›´ã§ successClear ã‚’å‘¼ã‚“ã§ã„ã‚‹ã®ã§
                // successClear å†…ã®å¤ã„ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                showElectronSpeech("ãƒŠã‚¤ã‚¹çµåˆï¼âœ¨");
                jumpElectron();
            }

            function showCompoundName(name) {
                const el = document.getElementById('compound-name-display');
                // ã‚¹ãƒãƒ›ç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã€ã€Œç”Ÿæˆï¼ã€ã®å‰ã§æ”¹è¡Œã‚’å…¥ã‚Œã‚‹
                el.innerHTML = name + "<span style='font-size:0.8em; display:block; margin-top:5px;'>ç”Ÿæˆï¼</span>";
                el.style.opacity = '1';
                el.style.transform = 'translate(-50%, -50%) scale(1.2)';

                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translate(-50%, -50%) scale(0.8)';
                }, 1000);
            }

            function updateScore() {
                const scoreEl = document.getElementById('score-val');
                scoreEl.innerText = Math.floor(score);
                scoreEl.style.transform = "scale(1.5)";
                setTimeout(() => scoreEl.style.transform = "scale(1)", 200);
            }

            function checkTitle() {
                const titleEl = document.getElementById('title-val');
                const speedEl = document.getElementById('speed-val');
                let currentTitle = TITLES[0].title;
                let newInterval = TITLES[0].interval;
                let level = 1;

                TITLES.forEach((t, i) => {
                    if (score >= t.score) {
                        currentTitle = t.title;
                        newInterval = t.interval;
                        currentScoreMultiplier = t.scoreMult;
                        level = i + 1;
                    }
                });

                // é›£æ˜“åº¦æ›´æ–°ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼‰
                if (currentSpawnInterval !== newInterval) {
                    currentSpawnInterval = newInterval;
                    showFlyingText("ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼âš¡ï¸", { x: window.innerWidth / 2, y: window.innerHeight / 2 - 50 });
                }

                // ã‚¹ãƒ”ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
                speedEl.innerText = "Lv." + level;

                let displayTitle = currentTitle;
                if (gameMode === 'hard') {
                    displayTitle += " (Hard)";
                }

                if (titleEl.innerText !== displayTitle) {
                    titleEl.innerText = displayTitle;
                    showFlyingText("ç§°å·ã‚¢ãƒƒãƒ—ï¼", { x: window.innerWidth / 2, y: window.innerHeight / 2 });
                }
            }

            // UIãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function showElectronSpeech(text) {
                const el = document.getElementById('electron-speech');
                el.innerText = text;
                el.style.opacity = 1;

                if (el.hideTimeout) clearTimeout(el.hideTimeout);
                el.hideTimeout = setTimeout(() => {
                    el.style.opacity = 0;
                }, 2000);
            }

            function shakeElectron() {
                const el = document.getElementById('electron-kun');
                el.style.transform = "translateX(5px)";
                setTimeout(() => el.style.transform = "translateX(-5px)", 50);
                setTimeout(() => el.style.transform = "translateX(5px)", 100);
                setTimeout(() => el.style.transform = "translateX(0)", 150);
            }

            function jumpElectron() {
                const el = document.getElementById('electron-kun');
                el.style.transform = "translateY(-20px)";
                setTimeout(() => el.style.transform = "translateY(0)", 200);
            }

            function createParticles(x, y, count, color) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.backgroundColor = color;
                    particle.style.left = `${x + (Math.random() - 0.5) * 10}px`;
                    particle.style.top = `${y + (Math.random() - 0.5) * 10}px`;
                    document.body.appendChild(particle);

                    const angle = Math.random() * Math.PI * 2;
                    const distance = (Math.random() * 50 + 20) * scaleFactor;
                    const translateX = Math.cos(angle) * distance;
                    const translateY = Math.sin(angle) * distance;

                    particle.animate([
                        { transform: `translate(0, 0) scale(${scaleFactor})`, opacity: 1 },
                        { transform: `translate(${translateX}px, ${translateY}px) scale(0)`, opacity: 0 }
                    ], {
                        duration: Math.random() * 500 + 500,
                        easing: 'ease-out',
                        fill: 'forwards'
                    }).onfinish = () => particle.remove();
                }
            }

            function showFlyingText(text, pos) {
                const div = document.createElement('div');
                div.className = 'flying-text';
                div.innerText = text;
                div.style.left = pos.x + 'px';
                div.style.top = pos.y + 'px';
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 1500);
            }

            function triggerGameOver() {
                if (isGameOver) return;
                isGameOver = true;
                sound.playGameOver();

                // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¿å­˜
                const highScore = localStorage.getItem('ion_highscore') || 0;
                if (score > highScore) {
                    localStorage.setItem('ion_highscore', score);
                }

                document.getElementById('final-score').innerText = score;
                document.getElementById('game-over-modal').style.display = 'flex';

                // ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³åˆ¤å®š
                checkRank(score);

                if (spawnTimer) clearTimeout(spawnTimer);
            }

            window.restartGame = function (retry = false) {
                if (retry) {
                    // ãƒªãƒˆãƒ©ã‚¤æ™‚ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                    const url = new URL(window.location.href);
                    url.searchParams.set('retry', '1');
                    url.searchParams.set('mode', gameMode); // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’ä¿æŒ
                    window.location.href = url.toString();
                } else {
                    // é€šå¸¸ãƒªãƒ­ãƒ¼ãƒ‰
                    location.reload();
                }
            };

            window.goToTitle = function () {
                // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¸ï¼‰
                const url = new URL(window.location.href);
                url.searchParams.delete('retry');
                url.searchParams.delete('mode');
                window.location.href = url.toString();
            }

            window.showHelp = function () {
                document.getElementById('help-modal').style.display = 'flex';
            }

            // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ (Firestore) ---
            async function loadRanking() {
                if (!db) return;
                const list = document.getElementById('ranking-list');
                try {
                    const snapshot = await db.collection('scores').orderBy('score', 'desc').limit(3).get();
                    if (snapshot.empty) {
                        list.innerHTML = '<div class="ranking-row"><span class="rank-name">No Data</span></div>';
                        return;
                    }

                    let html = '';
                    let rank = 1;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const rankClass = rank <= 3 ? `rank-${rank}` : '';
                        html += `
                        <div class="ranking-row ${rankClass}">
                            <span class="rank-num">${rank}</span>
                            <span class="rank-name">${escapeHtml(data.name)}</span>
                            <span class="rank-score">${data.score}</span>
                        </div>`;
                        rank++;
                    });
                    list.innerHTML = html;
                } catch (e) {
                    console.error("Error loading ranking:", e);
                    list.innerHTML = '<div class="ranking-row"><span class="rank-name">Error</span></div>';
                }
            }

            async function checkRank(score) {
                if (!db) return;
                if (score === 0) return; // 0ç‚¹ã¯ç™»éŒ²ä¸å¯

                try {
                    const snapshot = await db.collection('scores').orderBy('score', 'desc').limit(3).get();
                    // ãƒ‡ãƒ¼ã‚¿ãŒ3ä»¶æœªæº€ã€ã¾ãŸã¯3ä½ã®ã‚¹ã‚³ã‚¢ã‚ˆã‚Šé«˜ã„å ´åˆ
                    if (snapshot.size < 3 || score > snapshot.docs[snapshot.size - 1].data().score) {
                        document.getElementById('name-input-section').style.display = 'flex';
                    }
                } catch (e) {
                    console.error("Error checking rank:", e);
                }
            }

            async function registerRank() {
                if (!db) return;
                const nameInput = document.getElementById('player-name-input');
                const name = nameInput.value.trim() || "åç„¡ã—";

                try {
                    await db.collection('scores').add({
                        name: name,
                        score: score,
                        title: document.getElementById('title-val').innerText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã—ã¾ã—ãŸï¼");
                    document.getElementById('name-input-section').style.display = 'none';
                    loadRanking(); // å†èª­ã¿è¾¼ã¿
                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                }
            }

            function escapeHtml(str) {
                if (!str) return '';
                return str.replace(/[&<>"']/g, function (m) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    }[m];
                });
            }

            // --- ã‚²ãƒ¼ãƒ ä¿å­˜ãƒ»ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (å»ƒæ­¢) ---

            // åˆæœŸåŒ–æ™‚ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿
            window.addEventListener('load', () => {
                loadRanking();
            });

            window.hideHelp = function () {
                document.getElementById('help-modal').style.display = 'none';
            }

            // ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
            window.addEventListener('resize', () => {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã®ãƒªã‚»ãƒƒãƒˆãŒå¿…è¦ã ãŒã€ç¾åœ¨ã¯ãƒªãƒ­ãƒ¼ãƒ‰æ¨å¥¨
                // location.reload();
            });

            // é–‹å§‹å‡¦ç†
            window.addEventListener('load', () => {
                console.log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ­ãƒ¼ãƒ‰å®Œäº†");

                // ranking system replaced high score display

                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ (ãƒªãƒˆãƒ©ã‚¤ã‹ã©ã†ã‹)
                const urlParams = new URLSearchParams(window.location.search);
                const isRetry = urlParams.get('retry') === '1';
                const storedMode = urlParams.get('mode') || 'normal';

                if (isRetry) {
                    // ãƒªãƒˆãƒ©ã‚¤æ™‚ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¦å³ã‚¹ã‚¿ãƒ¼ãƒˆ
                    document.getElementById('title-screen').style.display = 'none';
                    // AudioContextã®é–‹å§‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ãŒã€
                    // ãƒªãƒ­ãƒ¼ãƒ‰ç›´å¾Œãªã®ã§ã‚¯ãƒªãƒƒã‚¯ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œãªã„ã€‚
                    // ãŸã ã—ã€ãƒªãƒ­ãƒ¼ãƒ‰å‰ã®ã‚¯ãƒªãƒƒã‚¯ãŒæœ‰åŠ¹ãªå ´åˆã‚‚ã‚ã‚‹ã€‚
                    // ã¨ã‚Šã‚ãˆãšé–‹å§‹ã‚’è©¦ã¿ã‚‹
                    setTimeout(() => {
                        initGame(storedMode); // ç›´æ¥initGameã‚’å‘¼ã¶
                    }, 100);
                }

                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                document.getElementById('start-btn').addEventListener('click', () => {
                    document.getElementById('title-screen').style.display = 'none';
                    startGameLogic();
                });

                function startGameLogic() {
                    // Matter.jsãƒã‚§ãƒƒã‚¯ã¨é–‹å§‹
                    try {
                        if (typeof Matter === 'undefined') {
                            throw new Error("Matter.js not loaded");
                        }
                        // AudioContextã®é–‹å§‹
                        if (sound.ctx.state === 'suspended') sound.ctx.resume().catch(e => console.log("Audio resume waiting for interaction"));

                        initGame();
                        setupRenderEvents();
                    } catch (e) {
                        console.error("ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:", e);
                        alert("ã‚¨ãƒ©ãƒ¼: Matter.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    }
                }
            });

            // --- å¤–éƒ¨å…¬é–‹é–¢æ•° ---
            window.initGame = initGame;
            window.showHelp = showHelp;
            window.hideHelp = hideHelp;
            window.goToTitle = goToTitle;
            window.restartGame = restartGame;
            window.registerRank = registerRank;

        })();
    </script>
</body>

</html>